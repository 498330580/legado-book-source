# 定时任务使用说明

## 概述

定时任务功能允许你设置自动化的书籍抓取任务，无需手动干预即可定期从书源网站抓取最新内容。

## 功能特性

- **定时执行**：按设定的时间间隔自动执行抓取任务
- **多种周期**：支持间隔执行和Cron表达式两种方式
- **任务日志**：记录每次执行的详细日志
- **后台运行**：与主服务一起启动，不影响正常使用

## 使用方法

### 1. 通过后台管理创建（推荐）

1. 访问管理后台：http://localhost:8000/admin/
2. 进入「定时任务」管理页面
3. 点击「添加定时任务」
4. 填写任务配置：
   - **任务名称**：给任务起个名字
   - **书源**：选择已配置的书源
   - **任务类型**：搜索 / 导入
   - **关键词**：搜索关键词或书籍URL
   - **执行类型**：
     - 间隔执行：设置秒数（如3600表示每小时执行一次）
     - Cron表达式：使用标准Cron格式（分 时 日 月 星期）
   - **状态**：启用
5. 保存后任务将自动开始执行

### 2. 通过API创建

```bash
# 创建定时任务
curl -X POST http://localhost:8000/api/scheduled-tasks/ \
  -H "Content-Type: application/json" \
  -d '{
    "name": "每日更新玄幻小说",
    "task_type": "search",
    "keyword": "玄幻",
    "source_url": "https://example.com",
    "interval_type": "interval",
    "interval_seconds": 86400,
    "description": "每天搜索并更新玄幻小说"
  }'

# 查看定时任务列表
curl http://localhost:8000/api/scheduled-tasks/

# 立即执行定时任务
curl -X POST http://localhost:8000/api/scheduled-tasks/1/run/

# 删除定时任务
curl -X DELETE http://localhost:8000/api/scheduled-tasks/1/
```

## 启动方式

### 方式一：使用启动脚本（推荐）

```bash
# 使用启动脚本，会同时启动Django服务和定时任务调度器
python start.py
```

### 方式二：分别启动

```bash
# 终端1：启动Django服务
python manage.py runserver 0.0.0.0:8000

# 终端2：启动定时任务调度器
python books/scrapers/scheduler.py
```

## 配置示例

### 示例1：每小时搜索更新

```
任务名称：每小时搜索玄幻小说
任务类型：搜索
关键词：玄幻
执行类型：间隔执行
间隔秒数：3600（1小时）
```

### 示例2：每天凌晨2点执行

```
任务名称：每日凌晨更新
任务类型：搜索
关键词：都市
执行类型：Cron表达式
Cron表达式：0 2 * * *
（表示每天凌晨2点执行）
```

### 示例3：每周同步特定书籍

```
任务名称：每周同步斗破苍穹
任务类型：导入
关键词：https://example.com/book/12345
执行类型：间隔执行
间隔秒数：604800（7天）
```

## 任务管理

### 在后台管理中

- **启用/暂停**：选中任务 → 选择动作 → 启用/暂停选中任务
- **立即执行**：选中任务 → 选择动作 → 立即执行
- **查看日志**：点击任务名称 → 查看关联的日志

### 监控任务状态

```
GET /api/scheduled-tasks/
```

响应示例：
```json
{
  "code": 0,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "name": "每小时搜索玄幻小说",
      "task_type": "search",
      "keyword": "玄幻",
      "status": "active",
      "last_run_time": "2024-01-15 14:30:00",
      "next_run_time": "2024-01-15 15:30:00",
      "total_runs": 15,
      "last_result_count": 5
    }
  ]
}
```

## 常见问题

### 1. 定时任务没有执行

检查项：
- 任务状态是否为「启用」
- 书源是否有效
- 网络连接是否正常
- 调度器是否已启动（查看启动日志）

### 2. 执行频率太高

建议：
- 合理设置间隔时间
- 避免对目标网站造成压力
- 遵守网站的robots.txt规则

### 3. 数据重复

系统会自动跳过已存在的书籍，但可能会产生重复的章节记录。
建议定期清理无效数据或在导入任务中使用唯一URL过滤。

### 4. 任务失败

查看任务日志了解失败原因：
1. 进入管理后台
2. 找到对应的定时任务
3. 查看「定时任务日志」关联对象
4. 检查错误信息

## 最佳实践

1. **合理设置间隔**：建议不低于5分钟
2. **分散执行时间**：多个任务设置不同的执行时间
3. **定期检查日志**：了解抓取情况
4. **设置结束时间**：对于临时任务，设置结束时间
5. **遵守网站规则**：合理控制请求频率

## 技术说明

- **调度器**：APScheduler（后台运行）
- **数据库**：SQLite（记录任务和日志）
- **执行方式**：多线程异步执行，不阻塞主服务

## 注意事项

1. 定时任务与主服务共用数据库
2. 大量任务可能影响系统性能
3. 建议在低峰期执行抓取任务
4. 定期备份数据库
